# Maintainer: ArchAssault <team@archassault.org>
pkgname=veil
pkgver=r11.8e11641
pkgrel=1
groups=('archassault' 'archassault-autonomous' 'archassault-exploit')
pkgdesc="A tool designed to generate metasploit payloads that bypass common anti-virus solutions."
url="https://github.com/Veil-Framework/Veil-Evasion"
arch=('any')
license=('GPL2')
depends=('python2' 'python2-cryptography' 'metasploit' 'impacket')
makedepends=('git')
provides=('veil-catapult' 'veil-evasion' 'veil-powerview')
##
# 'setup/setup.sh' wants to run the following to install deps ::
#
#  apt-get install mingw-w64 monodoc-browser monodevelop mono-mcs wine python python-cryptography
#
#  wget https://www.veil-evasion.com/InstallMe/requiredfiles.zip --no-check-certificate
#  wget https://www.veil-evasion.com/InstallMe/pyinstaller-2.0.zip --no-check-certificate
##
source=("Veil::git+https://github.com/Veil-Framework/Veil.git")
md5sums=('SKIP')

pkgver() {
  cd "$srcdir/Veil"
  printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"  
}

prepare() {
  cd "$srcdir/Veil"
  git submodule init
  git submodule update
  grep -iRl 'python' "$srcdir/Veil/*.py" | xargs sed -i | 's|#!.*/usr/bin/python|#!/usr/bin/python2|;s|#!.*/usr/bin/env python$|#!/usr/bin/env python2|'
}

package() {
  cd "$srcdir/Veil/Veil-Catapult"
  install -dm755 "$pkgdir/usr/share/veil-catapult"
  install -dm755 "$pkgdir/usr/bin/"
  cp -a * "$pkgdir/usr/share/veil-catapult"
  cat > "$pkgdir/usr/bin/veil-catapult" << EOF
#!/bin/sh
cd /usr/share/veil-catapult
python2 Veil-Catapult.py "\$@"
EOF
  chmod +x "$pkgdir/usr/bin/veil-catapult"

  cd "$srcdir/Veil/Veil-Evasion"
  install -dm755 "$pkgdir/usr/share/veil-evasion"
  install -dm755 "$pkgdir/usr/bin/"
  cp -a * "$pkgdir/usr/share/veil-evasion"
  cat > "$pkgdir/usr/bin/veil-evasion" << EOF
#!/bin/sh
cd /usr/share/veil-evasion
python2 Veil-Evasion.py "\$@"
EOF
  chmod +x "$pkgdir/usr/bin/veil-evasion"

  cd "$srcdir/Veil/Veil-PowerView"
  install -dm755 "$pkgdir/usr/share/veil-powerview"
  install -dm755 "$pkgdir/usr/bin/"
  cp -a * "$pkgdir/usr/share/veil-powerview"
}
