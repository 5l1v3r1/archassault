# Maintainer: ArchAssault <team archassault org>
pkgname=american-fuzzy-lop
pkgver=1.49b
pkgrel=1
groups=('archassault' 'archassault-fuzzers')
pkgdesc="A practical, instrumentation-driven fuzzer for binary formats"
arch=('i686' 'x86_64' 'armv7h')
url="http://lcamtuf.coredump.cx/afl/"
license=('APACHE')
depends=('bash')
options=('!strip')
source=("http://lcamtuf.coredump.cx/afl/releases/afl-${pkgver}.tgz" "makefile.patch")
sha512sums=('ec861c63b83cd04a2f71aa83ae37ff8c88df1ae99bfb69ea91f0d00ba5ab8729424d0fdab23c14f36e05fc399c4d324c8a9f2259b2a4d92bd3e1c57f9d67c1c5'
            '33e8838fb4f9dfc312753dcc59e94086abf26607614a6bf31ec0a5fe06d891f84d931766f9f07b94b29cdefe6b8e736cb4ab3b1ce4f9af4148bc750de279c485')

prepare(){
 cd "$srcdir/afl-$pkgver"
 patch < $srcdir/makefile.patch
}

build() {
  cd "$srcdir/afl-$pkgver"
  if [[ $CARCH == "armv7h" ]] || [[ $CARCH == "armv6h" ]]; then
     cp  experimental/arm_support/*.c .
     cp  experimental/arm_support/*.h .
     sed -i '/__asm__/d' Makefile
     export CFLAGS='-Wcpp -fstack-protector-strong'
     make
  else
     make
  fi
}

package() {
  cd "$srcdir/afl-$pkgver"
  install -dm755 $pkgdir/usr/bin
  install -dm755 $pkgdir/usr/lib/afl
  if [[ $CARCH == "armv7h" ]] || [[ $CARCH == "armv6h" ]]; then
        export CFLAGS='-Wcpp -fstack-protector-strong'
        make DESTDIR=$pkgdir install
  else
        make DESTDIR=$pkgdir install
  fi
}
