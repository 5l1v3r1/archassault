#Maintainer: ArchAssault <team archassault org>
pkgname=smartphone-pentest-framework-git
pkgver=r95.20918b2
pkgrel=1
groups=('archassault' 'archassault-backdoors')
pkgdesc="Repository for the Smartphone Pentest Framework (SPF)"
arch=('i686' 'x86_64')
url='https://github.com/georgiaw/Smartphone-Pentest-Framework'
license=('custom')
depends=('python2' 'apache' 'php-apache' 'apache-ant' 'mysql' 'python2-pyserial' 'python2-pexpect' 'mysql-python' 'android-sdk-platform-tools' 'android-sdk')
makedepends=('git')
provides=('smartphone-pentest-framework')
conflicts=('smartphone-pentest-framework')
replaces=('smartphone-pentest-framework')
source=("git+https://github.com/georgiaw/Smartphone-Pentest-Framework.git")
options=('!strip')
md5sums=('SKIP')

pkgver() {
  cd "$srcdir/Smartphone-Pentest-Framework"
  printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

prepare(){
  grep -iRl 'python' "$srcdir/Smartphone-Pentest-Framework" | xargs sed -i 's|#!.*/usr/bin/python|#!/usr/bin/python2|;s|#!.*/usr/bin/env python$|#!/usr/bin/env python2|'
}

package() {
  cd "$srcdir/Smartphone-Pentest-Framework"

  #clean up
  rm -fv "*install*"

  # Make base directories.
  install -dm755 "$pkgdir/usr/share/$pkgname"
  install -dm755 "$pkgdir/usr/bin"

  # Setup dirs
  for i in APKs AgentTemplates FrameworkAndroidApp FrameworkAndroidAppwithNFC arm-linux-androideabi-4.6 exploits frameworkconsole; do
      install -dm755 "$pkgdir/usr/share/$pkgname/$i"; done

  #Docs
  install -Dm644 "Version" "$pkgdir/usr/share/$pkgname/Version"
  install -Dm644 "README.md" "$pkgdir/usr/share/$pkgname/README.md"
  install -Dm644 "Smartphone Pentest Framework Manual.pdf" "$pkgdir/usr/share/$pkgname/Smartphone Pentest Framework Manual.pdf"
  install -Dm644 "license.rtf" "$pkgdir/usr/share/licenses/$pkgname/license.rtf"

  #Copy files into setup dirs
  for i in APKs AgentTemplates FrameworkAndroidApp FrameworkAndroidAppwithNFC arm-linux-androideabi-4.6 exploits frameworkconsole; do
      cp -a --no-preserve=ownership $i/* "$pkgdir/usr/share/$pkgname/$i/"; done

  #Configure config file for arch
  cd "$pkgdir/usr/share/$pkgname/frameworkconsole/"
  sed -i 's|/var/www|/srv/http|' config
  sed -i 's|/usr/share/android-sdk|/opt/android-sdk|' config
  sed -i 's|/root/Smartphone-Pentest-Framework/|/usr/share/smartphone-pentest-framework-git/|' config  

cat > "$pkgdir/usr/bin/smartphone-pentest-framework" << EOF
#!/bin/sh
cd /usr/share/smartphone-pentest-framework-git/frameworkconsole
python2 framework.py "\$@"
EOF

chmod +x "$pkgdir/usr/bin/smartphone-pentest-framework"
}
